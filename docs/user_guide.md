# 抵押贷款定价比较工具

## 项目概述

抵押贷款定价比较工具是一个用于分析和比较不同投资者抵押贷款定价表的应用程序。该工具可以帮助用户快速分析不同投资者之间的价格差异，识别最佳定价机会，并提供结构验证和异常检测功能。

主要功能包括：

1. 解析和处理AAA和投资者的DSCR定价表
2. 生成所有可能的借款人场景组合
3. 计算每个场景的最终价格和利润率
4. 提供多维筛选和分析功能
5. 反向定价分析和建议
6. 利润率异常检测
7. 表格结构一致性验证

## 安装指南

### 系统要求

- Python 3.8 或更高版本
- 足够的内存处理大型Excel文件（建议至少4GB RAM）

### 安装步骤

1. 克隆或下载项目代码到本地目录

```bash
git clone <repository-url> mortgage_pricing_tool
cd mortgage_pricing_tool
```

2. 安装依赖项

```bash
pip install -r requirements.txt
```

3. 安装开发模式的包（可选）

```bash
pip install -e .
```

## 使用指南

### 启动应用程序

在项目根目录下运行以下命令启动Streamlit应用程序：

```bash
streamlit run app.py
```

应用程序将在本地启动，并自动在默认浏览器中打开（通常是http://localhost:8501）。

### 上传和处理文件

1. 在应用程序主页面，您将看到两个文件上传区域：
   - AAA DSCR文件上传区
   - 投资者DSCR文件上传区

2. 上传相应的Excel文件（确保文件格式正确）

3. 选择是否在上传时验证结构（建议保持勾选）

4. 点击"处理文件"按钮开始处理

5. 处理完成后，您将看到筛选选项和结果区域

### 使用筛选功能

1. 在左侧筛选面板中，您可以选择各种维度进行筛选：
   - 利率范围
   - FICO分数
   - LTV比率
   - DSCR值
   - 贷款金额
   - 房产类型
   - 等等

2. 选择筛选条件后，点击"应用筛选"按钮

3. 结果将显示在右侧面板中，包括：
   - 筛选范围摘要
   - 样本大小
   - 平均最大利润率
   - 最佳投资者
   - 按投资者划分的利润率分布

### 结构验证功能

1. 点击侧边栏中的"结构验证"导航按钮

2. 点击"执行结构检查"按钮

3. 验证结果将显示：
   - 验证摘要（总表格数、有问题的表格数、问题百分比）
   - 问题详情（缺失模块、额外模块、LTV列不匹配、缺失基础价格行等）

### 反向定价功能

1. 点击侧边栏中的"反向定价"导航按钮

2. 设置目标利润率范围（最小值和最大值）

3. 选择要关注的投资者（或选择"任何投资者"）

4. 点击"分析目标利润率"按钮

5. 结果将显示：
   - 匹配场景数量
   - 目标利润率范围
   - 影响目标利润率的主要因素（图表和表格视图）

### 利润率异常检测

1. 点击侧边栏中的"利润率异常检测"导航按钮

2. 设置可接受的利润率范围（最小值和最大值）

3. 点击"检测利润率异常"按钮

4. 结果将显示：
   - 异常摘要（总异常数、过高异常数、过低异常数）
   - 异常详情（可按"全部"、"过高"、"过低"分类查看）

## 数据格式要求

### Excel文件格式

上传的Excel文件应包含以下内容：

1. LLPA调整表：
   - 每个模块应有明确的标题（例如"1. FICO/LTV"）
   - 每个表格应包含条件行和LTV列
   - LTV列应使用标准格式（例如"65-70%"、"<=65%"）

2. 基础价格表：
   - 应包含"Base Price"标题
   - 应包含利率列和价格列

### 标准化表格命名

- AAA表格应以"S-AAA"开头
- 投资者表格应以"S-"开头

## 故障排除

### 常见问题

1. **文件上传失败**
   - 确保Excel文件格式正确
   - 检查文件大小是否超过限制（通常为200MB）

2. **处理文件时出错**
   - 检查Excel文件结构是否符合要求
   - 确保文件中包含必要的LLPA调整表和基础价格表

3. **筛选后没有结果**
   - 尝试放宽筛选条件
   - 检查是否有冲突的筛选条件

4. **结构验证显示大量问题**
   - 检查投资者表格是否与AAA表格结构一致
   - 确保LTV列和模块顺序与AAA表格匹配

## 高级功能

### 导出结果

在各个功能页面中，您可以在"导出"选项卡中找到导出功能，可以将结果导出为CSV文件。

### 自定义分析

高级用户可以通过修改代码来自定义分析逻辑：

1. 修改`core/analyzer.py`中的分析方法
2. 修改`core/reverse_optimizer.py`中的影响因素计算
3. 修改`core/outlier_detector.py`中的异常检测逻辑

## 联系与支持

如有问题或需要支持，请联系项目维护者。
